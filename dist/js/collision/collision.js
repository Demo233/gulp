"use strict";function HashMap(){this.map={}}HashMap.prototype={put:function(e,i){this.map[e]=i},isExist:function(e){return!!this.map.hasOwnProperty(e)},get:function(e){return this.map.hasOwnProperty(e)?this.map[e]:null},remove:function(e){return!!this.map.hasOwnProperty(e)&&delete this.map[e]},removeAll:function(){this.map={}},keySet:function(){var e=[];for(var i in this.map)e.push(i);return e},size:function(){var e=0;for(var i in this.map)e++;return e}};var checkedMap=new(HashMap.prototype.constructor=HashMap),successNum=0,bimCollision={btnElement:null,currentCheckedNode:null,panelForClash:null,markupForClash:null,viewMode:!0,onceEdit:!1,beVisible:!1,defaultFid:"0",viewType:"1",toolCount:0,doCollision:function(){bimCollision.dockingPanelNone(),bimCollision.init(),toggleVisibilityForClash()},init:function(){var e=BimBdip.view;e.loadExtension("Autodesk.Viewing.MarkupsCore");bimCollision.markupForClash=new Autodesk.Viewing.Extensions.Markups.Core.MarkupsCore(e,{markupDisableHotkeys:!1}),bimCollision.markupForClash.load(),bimCollision.enterViewMode();var i=e.getToolbar(!0).getControl("bimbdip_viewToolBar").getControl("bimbdip_button_collision");bimCollision.btnElement=i.container},btn_markup:function(){0==bimCollision.toolCount&&(BimBdip.view.unloadExtension("Autodesk.ADN.Viewing.Extension.ClashPointMarkupTool",null),BimBdip.view.loadExtension("Autodesk.ADN.Viewing.Extension.ClashPointMarkupTool",null),bimCollision.panelForClash=BimBdip.view.loadedExtensions["Autodesk.ADN.Viewing.Extension.ClashPointMarkupTool"].getClashMarkup(),bimCollision.toolCount=1)},getGuid:function(){var n=(new Date).getTime();return"xxxx-xxxx-xxxx-xxxx".replace(/[xy]/g,function(e){var i=(n+16*Math.random())%16|0;return n=Math.floor(n/16),("x"==e?i:7&i|8).toString(16)})},randomWord:function(e,i,n){var l="",o=i,a=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];e&&(o=Math.round(Math.random()*(n-i))+i);for(var t=0;t<o;t++)pos=Math.round(Math.random()*(a.length-1)),l+=a[pos];return l},getPreViewData:function(e){var i=bimCollision.randomWord(!0,16,32);if(checkedMap.isExist(e.id)){var n=checkedMap.get(e.id),l="",o=n.markup,a=new Array;if(0<o.length&&(a=o.split("@#@")),!bimCollision.viewMode)null!=(r=bimCollision.markupForClash.generateData().replace(/\"/g,"'"))&&0<r.length&&(l+=i+"@BIM@"+r,a.push(l));var t=a.join("@#@");n.markup=t,checkedMap.put(e.id,n)}else{var r,s=bimCollision.getGuid(),d=BimBdip.view.getState(),c=JSON.stringify(d).replace(/\"/g,"'"),u=BimBdip.view.getScreenShotBuffer(),m=bimCollision.dataURLtoBlob(u),p="";if(!bimCollision.viewMode)null!=(r=bimCollision.markupForClash.generateData().replace(/\"/g,"'"))&&0<r.length&&(p+=i+"@BIM@"+r);var h={jsonString:c,imageString:m,markup:p,guid:s,add_id:s,name:e.name,fid:bimCollision.defaultFid,urlString:BimBdip.view_modelUrl,type:bimCollision.viewType,userid:BimBdip.currentUserid,username:BimBdip.currentUsername,modelid:BimBdip.lvmid};checkedMap.put(e.id,h)}},dataURLtoBlob:function(e){for(var i=e.split(","),n=i[0].match(/:(.*?);/)[1],l=atob(i[1]),o=l.length,a=new Uint8Array(o);o--;)a[o]=l.charCodeAt(o);return new Blob([a],{type:n})},enterEditMode:function(){bimCollision.viewMode=!1,bimCollision.onceEdit=!0,bimCollision.markupForClash.show(),bimCollision.markupForClash.enterEditMode()},enterViewMode:function(){bimCollision.viewMode=!0,bimCollision.onceEdit=!1,bimCollision.markupForClash.leaveEditMode(),bimCollision.markupForClash.hide()},dockingPanelNone:function(){var e=$(".markup");if(e&&0<e.length)for(var i=0;i<e.length;i++){e[i].style.display="none"}bimViewPointNew&&bimViewPointNew.hiddenViewPoint(),bimHistory&&hideButtonForHistory()}};function ajax_clash_upload(){var e=!0,i="文件类型错误（仅支持xml格式的文件）",n=document.getElementById("clashReport").files;if(n&&0<n.length)for(var l=0;l<n.length;l++){if("xml"!=n[l].name.replace(/.+\./,"").toLowerCase()){e=!1;break}}else i="",e=!1;if(e){var o="",a="";BimBdip.be3DViewer&&(o=BimBdip.view_modelUrl,a=BimBdip.lvmid);var t=BimBdip.currentUserid,r=BimBdip.currentUsername;showMask(bdip4dLang[langType][-15403]+"..."),$.ajaxFileUpload({url:publicJS.tomcat_url+"/ClashPoint_insertClashPoint.action?modelurl="+o+"&userid="+t+"&username="+r+"&modelid="+a,fileElementId:"clashReport",type:"POST",dataType:"JSON",secureuri:!1,success:function(e){changeMask(bdip4dLang[langType][-15404]),changeMask(bdip4dLang[langType][-15405]),setTimeout(function(){hideMask(),selectClashAll()},1e4)},error:function(e){changeMask(bdip4dLang[langType][-15406]),hideMask()}})}else i&&0<i.length&&Dialog.alert(i)}function selectClashAll(){bimCollision.markupForClash&&bimCollision.enterViewMode(),bimCollision.currentCheckedNode=null,checkedMap.removeAll();var e="";BimBdip.be3DViewer&&(e=BimBdip.view_modelUrl,BimBdip.lvmid),$.ajax({url:publicJS.tomcat_url+"/ClashPoint_selectAllClashPoint.action?modelurl="+e,type:"POST",dataType:"JSON",timeout:1e4,async:!1,success:function(e){e&&0<e.length?showClashAll(e):document.getElementById("clashRpt-tbody").innerHTML=""},error:function(e){Dialog.alert(bdip4dLang[langType][-15407]+"!")}})}function showClashAll(e){for(var i=document.getElementById("clashRpt-tbody").innerHTML="",n=0;n<e.length;n++){for(var l=new Array,o=new Array,a=new Array,t=new Array,r=JSON.parse(e[n].objectId),s=0;s<r.length;s++){(k=r[s].objId)&&0<k.length&&l.push(k)}for(var d=l.join(","),c=JSON.parse(e[n].layer),u=0;u<c.length;u++){(k=c[u].layer)&&0<k.length&&o.push(k)}for(var m=o.join(","),p=JSON.parse(e[n].pathLink),h=0;h<p.length;h++){(k=p[h].pathLink)&&0<k.length&&a.push(k)}for(var C=a.join(","),g=JSON.parse(e[n].smartTags),b=0;b<g.length;b++){var k;(k=g[b].projectName)&&0<k.length&&t.push(k)}var v=t.join(",");i+="<tr>",i+='<td id="check"><input class="check_btn" type="checkbox" onclick="clashChecked(this)" name="answer" value="'+d+'"  id="'+e[n].id+'" clashType="'+e[n].type+'" layers="'+m+'" tags="'+v+'"/></td>',i+='<td class="clashname" id="clashname" title="'+e[n].name+'">'+e[n].name+"</td>",i+='<td class="gridlocation" id="gridlocation" title="'+e[n].gridLocation+'">'+e[n].gridLocation+"</td>",i+='<td class="pathlink" id="pathlink" title="'+C+'">'+C+"</td>",i+="</tr>"}document.getElementById("clashRpt-tbody").innerHTML=i}function btn_clashDelete(){var a=$("input[name='answer']:checked");if(0==$("input[name='answer']:checked").length)return layer.msg(bdip4dLang[langType][-15408]+"!",{icon:7,time:1e3}),!1;Dialog.confirm(bdip4dLang[langType][-15409]+"?",function(){for(var e=new Array,i=0;i<a.length;i++){var n=a[i].id;e.push(n)}var l=e.join(","),o=new FormData;o.append("deleteIds",l),$.ajax({url:publicJS.tomcat_url+"/ClashPoint_deleteClashPoint.action",type:"POST",data:o,dataType:"JSON",processData:!1,contentType:!1,success:function(){Dialog.alert(bdip4dLang[langType][-15412]+"!"),selectClashAll()},error:function(){Dialog.alert(bdip4dLang[langType][-15410]+"!")}})},function(){Dialog.alert(bdip4dLang[langType][-15411])})}function btn_clashSave(){bimCollision.currentCheckedNode&&(bimCollision.getPreViewData(bimCollision.currentCheckedNode),bimCollision.markupForClash&&bimCollision.enterViewMode(),bimCollision.currentCheckedNode=null);var e=$("input[name='answer']:checked");if(0==$("input[name='answer']:checked").length)return layer.msg(bdip4dLang[langType][-15408]+"!",{icon:7,time:1e3}),!1;for(var i=new Array,n=0;n<e.length;n++){var l=e[n].id;i.push(l)}onSave(i,checkedMap)}function onSave(e,n){for(var l=new Array,i=0;i<e.length;i++)n.isExist(e[i])&&l.push(n.get(e[i]));if(l&&0<l.length){showMask(bdip4dLang[langType][-15413]+"..."),saveAction(l);var o=setInterval(function(){if(successNum>=l.length){clearInterval(o),changeMask(bdip4dLang[langType][-15414]),hideMask(),n.removeAll();for(var e=document.getElementsByName("answer"),i=0;i<e.length;i++)e[i].checked=!1;successNum=0}},200)}else showMask(bdip4dLang[langType][-15415]),hideMask()}function saveAction(e){var i=setInterval(function(){saveActionOne(e),successNum>=e.length&&clearInterval(i)},1500)}function saveActionOne(e){if(!(successNum>=e.length)){var i=new FormData,n=e[successNum];i.append("jsonString",n.jsonString),i.append("image",n.imageString),i.append("markup",n.markup),i.append("guid",n.guid),i.append("add_id",n.add_id),i.append("name",n.name),i.append("fid",n.fid),i.append("url",n.urlString),i.append("type",n.type),i.append("userid",n.userid),i.append("username",n.username),i.append("modelid",n.modelid),$.ajax({url:publicJS.tomcat_url+"/ViewerSave_clashToView.action",type:"POST",data:i,dataType:"text",processData:!1,contentType:!1,async:!1,cache:!0,success:function(){successNum++},error:function(){successNum++}})}}function clashChecked(e){if(1==e.checked){sureCheck();for(var i=e.id,n=e.value,l=(e.getAttribute("clashType"),0==e.getAttribute("layers").replace(/(^\s*)|(\s*$)/g,"").length?"0":e.getAttribute("layers").replace(/(^\s*)|(\s*$)/g,"")),o=0==e.getAttribute("tags").replace(/(^\s*)|(\s*$)/g,"").length?"0":e.getAttribute("tags").replace(/(^\s*)|(\s*$)/g,""),a=e.parentNode.parentNode.cells,t="",r=0;r<a.length;r++){var s=a[r].id;"clashname"!=s&&"gridlocation"!=s&&"pathlink"!=s||(0<a[r].innerHTML.replace(/(^\s*)|(\s*$)/g,"").length?t+=a[r].innerHTML+"@#@":t+="0@#@")}t+=l+"@#@"+o,null==bimCollision.currentCheckedNode||(bimCollision.getPreViewData(bimCollision.currentCheckedNode),bimCollision.markupForClash&&bimCollision.enterViewMode()),bimCollision.currentCheckedNode={id:i,name:t};for(var d=n.split(","),c=[],u=0;u<d.length;u++){var m=d[u];BimBdip.view.model.search(m,function(e){c.push(e[0]),u==d.length&&(BimBdip.view.fitToView(c),BimBdip.view.isolate(c))})}}else sureUncheck(),bimCollision.currentCheckedNode&&(bimCollision.getPreViewData(bimCollision.currentCheckedNode),bimCollision.markupForClash&&bimCollision.enterViewMode(),bimCollision.currentCheckedNode=null)}function sureCheck(){var e=0,i=document.getElementsByName("answer"),n=i.length;if(i&&0<i.length)for(var l=0;l<i.length;l++)i[l].checked&&e++;e==n?$("input:checkbox[name='allClick']").attr("checked",!0):$("input:checkbox[name='allClick']").attr("checked",!1)}function sureUncheck(){$("input:checkbox[name='allClick']").attr("checked",!1)}function checkAllBoxForClash(e){bimCollision.markupForClash&&bimCollision.enterViewMode(),bimCollision.currentCheckedNode=null;var i=document.getElementsByName("answer");if(1==e.checked)for(var n=0;n<i.length;n++)i[n].checked=!0;else for(n=0;n<i.length;n++)i[n].checked=!1}function closeClashRpt(){setVisibleForClash(!1)}function setVisibleForClash(e){bimCollision.beVisible=e,bimCollision.btnElement.classList.toggle("active"),e?($("#u-clashRpt-upload").show(),selectClashAll()):(bimCollision.markupForClash&&(bimCollision.markupForClash.leaveEditMode(),bimCollision.markupForClash.hide(),BimBdip.view.unloadExtension("Autodesk.Viewing.MarkupsCore"),bimCollision.markupForClash=null),bimCollision.viewMode=!0,bimCollision.onceEdit=!1,$("#u-clashRpt-upload").hide(),bimCollision.panelForClash&&bimCollision.panelForClash.setVisible(!1))}function toggleVisibilityForClash(){setVisibleForClash(!bimCollision.beVisible)}function hideButtonForClash(){bimCollision.markupForClash&&(bimCollision.markupForClash.leaveEditMode(),bimCollision.markupForClash.hide(),BimBdip.view.unloadExtension("Autodesk.Viewing.MarkupsCore"),bimCollision.markupForClash=null),bimCollision.viewMode=!0,bimCollision.onceEdit=!1,bimCollision.beVisible=!1,$("#u-clashRpt-upload").hide(),bimCollision.panelForClash&&bimCollision.panelForClash.setVisible(!1),$(bimCollision.btnElement).removeClass("active"),$(bimCollision.btnElement).addClass("inactive")}function showButtonForClash(){$(bimCollision.btnElement).removeClass("inactive"),$(bimCollision.btnElement).addClass("active")}