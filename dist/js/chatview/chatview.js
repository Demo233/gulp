"use strict";var chatview={chat:function(e,a,i,t,d,n){var o="";1==n?(d="./../../bdipCloud/bdipimg/modeltool/chatview/closechat.png",o="textname_clo"):(d="./../../bdipCloud/img/modeltool/chatview/chat2.png",o="textname"),_gyroext.chat(e,a,i,t,d,o)},focusPoint:function(e){viewChatShow(e)},chatClean:function(){var e=document.getElementsByName("viewChatTags"),a=e.length;if(0!=a)for(var i=0;i<a;i++)e[0].parentNode.removeChild(e[0]);$(".discussDivClass").remove()},cleanAll:function(){for(var e=document.getElementsByClassName("pnamed"),a=0;a<e.length;a++)e[a].style.display="none";$(".discussDivClass").remove()},talking:function(){var e=BimBdip.view.getState(),a=JSON.stringify(e);a=a.replace(/\"/g,"'");var i="",t="";if(BimBdip.view.model.getData().instanceTree.enumNodeFragments(BimBdip.view.getSelection()[0],function(e){i=e,t=BimBdip.view.getSelection()[0]}),""!=t){var d=BimBdip.view_modelUrl,n=BimBdip.lvmid,o=new FormData,s=BimBdip.currentUserid;o.append("userId",s),o.append("bdipChatPoint.json",a),o.append("bdipChatPoint.modelUrl",d),o.append("bdipChatPoint.dbId",t),o.append("bdipChatPoint.fragId",i),o.append("bdipChatPoint.treeId",n),o.append("projId",BimBdip.modelObject.project),o.append("modelName",BimBdip.view_modelName);var l=BimBdip.view.getScreenShotBuffer();compressImg(l,450,250,function(e){var a=dataURLToBlob(e);null!==a||void 0!==a||""!==a?(o.append("file",a),savePoint(o)):Dialog.alert(bdip4dLang[langType][-16069])})}else Dialog.alert("暂不支持多构件发起实时讨论")},loadShareList:function(e){var a=publicJS.tomcat_url+"/chat/getMembersByProjId.action",i=new FormData;i.append("createBy",BimBdip.currentUserid),i.append("projId",BimBdip.modelObject.project),$.ajax({url:a,type:"POST",data:i,dataType:"json",processData:!1,contentType:!1,success:function(e){},error:function(e){}})},viewChatSubmitFunc:function(){var e=$("textarea").val();if(""!=e.trim()){var a=$("input[name='userId']").val(),i=$("input[name='modelUrl']").val(),t=$("input[name='pointId']").val(),d=BimBdip.currentUserid,n=BimBdip.currentUsername,o=BimBdip.view_modelName,s=new FormData;s.append("remark",o),s.append("createBy",d),s.append("updateBy",d),s.append("receiveId",a),s.append("userName",n),s.append("modelUrl",i),s.append("pointId",t),s.append("comment",e),s.append("projId",BimBdip.modelObject.project);var l=$("#chatViewForm").find(".dropdown-selected i");0!=l.length&&l.each(function(){s.append("sendBys",this.getAttribute("data-id"))}),s.append("lvmId",BimBdip.lvmid),showMask("loading..."),$.ajax({url:publicJS.tomcat_url+"/message/saveMessage.action",type:"POST",data:s,dataType:"json",processData:!1,contentType:!1,success:viewChatSaveCallBack,error:function(e,a,i){hideMask(),Dialog.alert(bdip4dLang[langType][-15057]+e+":"+a+":"+i)}})}else Dialog.alert(bdip4dLang[langType][-15055])},offlinePointFunc:function(){var e=$("input[name='pointId']").val();showMask("loading...");var a=new FormData;a.append("id",e),$.ajax({url:publicJS.tomcat_url+"/chat/offlinePoint.action",type:"post",data:a,dataType:"json",processData:!1,contentType:!1,success:function(e){if(200==e.code){var a=e.data.id;$("#a_"+a).parent().remove();var i=e.data.dbId,t=e.data.fragId,d=e.data.viewPointNum,n=e.data.enable;chatview.chat(a,i,t,d,"",n),window.parent.show_discussRightList(),hideMask()}else Dialog.alert(bdip4dLang[langType][e.code]),hideMask()},error:function(e){Dialog.alert(e),hideMask()}})},onlinePointFunc:function(){var e=$("input[name='pointId']").val();showMask("loading..."),$.ajax({url:publicJS.tomcat_url+"/chat/onlinePoint.action",type:"post",data:{id:e},dataType:"json",success:function(e){if(200==e.code){var a=e.data.id;$("#a_"+a).parent().remove();var i=e.data.dbId,t=e.data.fragId,d=e.data.viewPointNum,n=e.data.enable;chatview.chat(a,i,t,d,"",n),window.parent.show_discussRightList(),hideMask()}else Dialog.alert(bdip4dLang[langType][e.code]),hideMask()},error:function(e){Dialog.alert(e),hideMask()}})}};function discussCompress(i,e){compressImg(e,450,250,function(e){var a=dataURLToBlob(e);null!==a||void 0!==a||""!==a?(i.append("file",a),savePoint(i)):Dialog.alert(bdip4dLang[langType][-16069])})}function savePoint(e){showMask("loading...");var a=publicJS.tomcat_url+"/chat/save.action";$.ajax({url:a,type:"POST",data:e,async:!1,processData:!1,contentType:!1,dataType:"json",success:function(e){if("200"==e.code){var a=e.data.id,i=e.data.dbId,t=e.data.fragId,d=e.data.viewPointNum,n=e.data.headImage,o=e.data.userName,s=dateFormatUtil(e.data.createTime),l=publicJS.tomcat_url+"/bdipCloud/img/modeltool/chatview/recycle46.png",c=(e.data.json,publicJS.file_static_prefix()+"/discuss/"+e.data.picture);chatview.chat(a,i,t,d,"./../../bdipCloud/img/modeltool/chatview/chat2.png","1"),viewChatShow(a);var p=parent.document.getElementById("asideChatView"),r=$(p).find(".m-message"),m='<div class="chatContent" name="chatContent_'+a+'"><div class="top"><img class="chatHeadImage" src="'+n+'"><div class="chatUser"><div class="chatUsermessage"><div class="chatUserName">'+o+'</div><div class="chatTime">'+s+'</div></div><div class="chatDelete"><span class="viewPointNum"><b class="textNum">'+d+'</b></span><a href="javascript:void(0);" onclick="deleteChat('+a+')" title="'+bdip4dLang[langType][-16052]+'"><img class="deleteLogo" src="'+l+'"></a></div></div></div><div class="middle"><a href="javascript:void(0);" onclick="focusPoint('+a+')"><img class="chatPicture" style="width: 100%;" src="'+c+'"></a></div></div>';r.append(m)}else Dialog.alert(bdip4dLang[langType][e.code]);hideMask()},error:function(e,a,i){hideMask(),Dialog.alert(bdip4dLang[langType][-15392]+e+":"+a+":"+i)}})}function viewChatShow(a){var e=$(".viewChatBox");e&&e.each(function(){this.remove()}),$("#a_"+a).next("div.g-gif-div").html('<img src="'+publicJS.tomcat_url+'/bdipCloud/img/icon/loading01.gif">'),$.ajax({url:publicJS.tomcat_url+"/chat/findById.action",type:"POST",data:{userId:BimBdip.currentUserid,id:a,projId:BimBdip.modelObject.project},dataType:"json",success:function(e){showSuccessCallBack(e,a)},error:function(e,a,i){Dialog.alert(bdip4dLang[langType][-15365])}})}function showSuccessCallBack(e,a){var i=e.data.chatViewPoint,t=i.id,d=publicJS.file_static_prefix()+"/discuss/"+i.picture,n=i.modelUrl,o=i.enable,s=i.json.replace(/'/g,'"'),l=JSON.parse(s),c=i.userName,p=i.createBy,r=dateFormatUtil(i.createTime),m=i.headImage;BimBdip.view.restoreState(l);var v=publicJS.tomcat_url+"/bdipCloud/img/modeltool/chatview/viewChat_pldown.png",u="comment_"+a,h=$("#a_"+a).siblings("div[name='"+u+"']"),g=BimBdip.currentUsername,w=BimBdip.currentUserid,f='<div class="viewChatBox"><form action="#" id="chatViewForm" method="post"><input type="hidden" value="'+g+'" name="currentUserName"><input type="hidden" value="'+w+'" name="currentUserId"><input type="hidden" value="'+p+'" name="userId"><input type="hidden" value="'+n+'" name="modelUrl"><input type="hidden" value="'+t+'" name="pointId"><div class="viewChatTitle"><div class="g-viewChat_title-content"><div class="g-view_title-img"><img src="'+m+'" alt=""></div><div class="g-view_title-user"><div class="u-view-creatName" id="'+p+'">'+c+'</div><div class="u-view-creatTime">'+r+'</div></div></div><div class="g-viewChat_title-aside"><input type="button" value="×" title="'+bdip4dLang[langType][-15287]+'" id="commentClose"><input type="button" title="'+bdip4dLang[langType][-15285]+'" id="commentDelete"></div></div><div class="viewChatContent"><div id="viewChatTable"><div class="viewChatPicture" name="picture"><img name="picture" src="'+d+'" ></div><ul id="comment_ul" class="g-content-comment">',b=e.data.bimChatMessageList,y=b.length;if(0<y)for(var B=0;B<y;B++){f+='<li><div class="g-content-reply"><div class="g-reply-title"><b class="m-reply-userName">'+b[B].userName+'</b><b class="m-reply-time">'+dateFormatUtil(b[B].createTime)+'</b><div class="g-reply-content" >'+b[B].comment+'</div></div>\t<div class="vertical-line"></div></div></li>'}if(f+="</ul></div>","1"==o?(f+='<textarea class="reply-area" name="comment" rows="" cols="" placeholder="'+bdip4dLang[langType][-15214]+'"></textarea><div class="dropdown-sin-discuss discuss-select" readOnly="true"><select name="sendBys" style="display:none" multiple placeholder="'+bdip4dLang[langType][-15215]+'"></select></div><div class="g-comment-footer" name="submit" align="left"><input type="button" value="'+bdip4dLang[langType][-15216]+'" id="viewChatSubmit"/>',w==p&&(f+='<input type="button" id="offlinePoint" value="'+bdip4dLang[langType][-15217]+'"/>'),f+="</div>"):w==p&&(f+='<div class="g-comment-footer" name="submit" align="left"><input type="button" id="onlinePoint" value="'+bdip4dLang[langType][-15218]+'"/></div>'),f+='</div><img class="g-add-img" src="'+v+'"></form></div>',h.html(f),void 0!==e.data.members&&0!=e.data.members.length&&"1"==o){var C=$("#chatViewForm").find("select[name='sendBys']"),T="";e.data.members.forEach(function(e,a){T+='<option value="'+e.id+'">'+e.lastname+"</option>"}),C.append(T),$(".dropdown-sin-discuss").dropdown({input:'<input type="text" maxLength="20" placeholder="'+bdip4dLang[langType][-15219]+'">',choice:function(){}})}h.show(),void 0!==$("#viewChatSubmit")[0]&&$("#viewChatSubmit").click(chatview.viewChatSubmitFunc),void 0!==$("#offlinePoint")[0]&&$("#offlinePoint").click(chatview.offlinePointFunc),void 0!==$("#onlinePoint")[0]&&$("#onlinePoint").click(chatview.onlinePointFunc),void 0!==$("#viewChatReset")[0]&&$("#viewChatReset").click(function(){$(".reply-area").val("")}),$("#commentClose").click(function(){$(".viewChatBox").hide()}),$(".dropdown-sin-discuss .dropdown-search").after('<span class="selectAll"><input type="checkbox" style="width: "><span style="">'+bdip4dLang[langType][-15220]+"</span></span>"),$(".selectAll>input").click(function(){var e="",a=[];1==$(".selectAll>input").is(":checked")?($(".dropdown-sin-discuss .dropdown-option").addClass("dropdown-chose"),$(".dropdown-sin-discuss .dropdown-option").each(function(){e+='<span class="dropdown-selected">'+$(this).text()+'<i class="del" data-id="'+$(this).attr("data-value")+'"></i></span>',a.push($(this).text())}),$(".dropdown-sin-discuss .dropdown-chose-list .placeholder").before(e)):($(".dropdown-sin-discuss .dropdown-option").removeClass("dropdown-chose"),$(".dropdown-sin-discuss .dropdown-chose-list .dropdown-selected").remove(),a=[]),$(".dropdown-sin-discuss .dropdown-display").attr("title",a.join(","))})}function viewChatSaveCallBack(e){if("200"==e.code){$(".g-content-comment").empty();for(var a=e.data.length,i=0;i<a;i++){var t='<li><div class="g-content-reply"><div class="g-title-right">';t+='<b class="m-reply-userName">'+e.data[i].userName+"</b>",t+='<b class="m-reply-time">'+dateFormatUtil(e.data[i].createTime)+"</b>",t+='</div><b class="m-replay">'+e.data[i].comment+"</b>",t+="</div></li>",$(".g-content-comment").append(t),$("textarea[name='comment']").val("")}}else Dialog.alert(bdip4dLang[langType][-15056]);hideMask()}