"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var n=0,t=Array(e.length);n<e.length;n++)t[n]=e[n];return t}return Array.from(e)}function MySelectionWindow(e,n){Autodesk.Viewing.Extension.call(this,e,n);var l=this.viewer,O=null,o=l.canvas.parentElement,z=o.getBoundingClientRect().top,W=o.getBoundingClientRect().left,r=[],c=null,a=new THREE.Vector3(0,0,-10),s=new THREE.Vector3(0,0,-10),d=!1,t=null,u=null,v=null;function E(){l.navigation.setIsLocked(!1),o.removeEventListener("mouseup",m),o.removeEventListener("mousemove",y),d=!1,l.impl.removeOverlayScene("selectionWindowOverlay"),BimBdip.view.getToolbar().getControl(av.TOOLBAR.BASEMODELSHOWSID)._controls[8].container.classList.remove("active"),BimBdip.isFullScreen=!BimBdip.isFullScreen,c=null}function i(e){if(83==e.keyCode){l.navigation.setIsLocked(!0),o.addEventListener("mousedown",g);var n=l.canvas,t=n.clientWidth,i=n.clientHeight,r=new THREE.OrthographicCamera(0,t,0,i,1,1e3);l.impl.createOverlayScene("selectionWindowOverlay",v,v,r)}return 81==e.keyCode&&(l.navigation.setIsLocked(!1),o.removeEventListener("mouseup",m),o.removeEventListener("mousemove",y),d=!1,l.impl.removeOverlayScene("selectionWindowOverlay")),!0}function y(e){d&&(s.x=e.clientX-W,s.y=e.clientY-z,t.vertices[1].x=a.x,t.vertices[1].y=s.y,t.vertices[2]=s.clone(),t.vertices[3].x=s.x,t.vertices[3].y=a.y,t.vertices[4]=t.vertices[0],t.verticesNeedUpdate=!0,l.impl.invalidate(!1,!1,!0))}function m(e){if(l.canvas.classList.remove("crosshair"),d){s.x=e.clientX-W,s.y=e.clientY-z,l.impl.removeOverlay("selectionWindowOverlay",u),d=!1,o.removeEventListener("mouseup",m),o.removeEventListener("mousemove",y);var n=function(e,n,t){var i=Math.min(e.clientX,n.clientX),r=Math.max(e.clientX,n.clientX),o=Math.min(e.clientY,n.clientY),c=Math.max(e.clientY,n.clientY),a=k({clientX:i+W,clientY:o+z}),l=k({clientX:r+W,clientY:o+z}),s=k({clientX:r+W,clientY:c+z}),d=k({clientX:i+W,clientY:c+z}),u=new THREE.Vector3(0,0,0);u.add(a.origin),u.add(l.origin),u.add(s.origin),u.add(d.origin),u.multiplyScalar(.25);var v=O,E=v.center,y=v.radius,m=new THREE.Vector3(u.x-E.x,u.y-E.y,u.z-E.z),g=y+m.length(),w=a.direction.angleTo(l.direction),p=g/Math.cos(.5*w),f=new THREE.Vector3(a.origin.x+a.direction.x*p,a.origin.y+a.direction.y*p,a.origin.z+a.direction.z*p),x=new THREE.Vector3(l.origin.x+l.direction.x*p,l.origin.y+l.direction.y*p,l.origin.z+l.direction.z*p),h=new THREE.Vector3(s.origin.x+s.direction.x*p,s.origin.y+s.direction.y*p,s.origin.z+s.direction.z*p),T=new THREE.Vector3(d.origin.x+d.direction.x*p,d.origin.y+d.direction.y*p,d.origin.z+d.direction.z*p),R=new THREE.Plane,H=new THREE.Plane,b=new THREE.Plane,L=new THREE.Plane,V=new THREE.Plane;R.setFromCoplanarPoints(u,f,x),H.setFromCoplanarPoints(u,x,h),b.setFromCoplanarPoints(u,h,T),L.setFromCoplanarPoints(u,T,f),V.setFromCoplanarPoints(h,x,f);var B=function(e,n,t){var i=[],r=[],o=[],c=[{a:n[0],b:n[1],c:n[2]},{a:n[0],b:n[2],c:n[3]},{a:n[1],b:n[0],c:n[4]},{a:n[2],b:n[1],c:n[4]},{a:n[3],b:n[2],c:n[4]},{a:n[0],b:n[3],c:n[4]}],a=!0,l=!1,s=void 0;try{for(var d,u=_boundingBoxInfo[Symbol.iterator]();!(a=(d=u.next()).done);a=!0){var v=d.value;A(e,v.bbox)?o.push(v):t&&I(v.bbox,c)?i.push(v):r.push(v)}}catch(e){l=!0,s=e}finally{try{!a&&u.return&&u.return()}finally{if(l)throw s}}return{intersect:i,outside:r,inside:o}}([R,H,b,L,V],[f,x,h,T,u],t),S=B.inside.map(function(e){return e.dbId});if(t){var C=B.intersect.map(function(e){return e.dbId});return[].concat(_toConsumableArray(S),_toConsumableArray(C))}return S}({clientX:a.x,clientY:a.y},{clientX:s.x,clientY:s.y},!1),t=null,i=null;switch(c){case 16:t=_.intersection(n,r),i=_.difference(r,t),l.select(i),r=i;break;case 17:i=_.union(r,n),l.select(i),r=i;break;default:l.select(n),r=n}setTimeout(E,20)}}function g(e){if(a.x=e.clientX-W,a.y=e.clientY-z,d=!0,null===u){(t=new THREE.Geometry).vertices.push(a.clone(),a.clone(),a.clone(),a.clone(),a.clone());var n=new THREE.Line(t,v,THREE.LineStrip);(u=new THREE.Group).add(n)}else t.vertices[0]=a.clone(),t.vertices[1]=a.clone(),t.vertices[2]=a.clone(),t.vertices[3]=a.clone(),t.vertices[4]=a.clone(),t.verticesNeedUpdate=!0;l.impl.addOverlay("selectionWindowOverlay",u),l.impl.invalidate(!1,!1,!0),o.addEventListener("mouseup",m),o.addEventListener("mousemove",y)}function k(e){var n=l.navigation.getCamera(),t=new THREE.Vector3,i=new THREE.Raycaster,r=new THREE.Vector3,o=l.canvas.getBoundingClientRect(),c=(e.clientX-o.left)/o.width*2-1,a=-(e.clientY-o.top)/o.height*2+1;return n.isPerspective?(t.set(c,a,.5),t.unproject(n),i.set(n.position,t.sub(n.position).normalize())):(t.set(c,a,-15),t.unproject(n),r.set(0,0,-1),i.set(t,r.transformDirection(n.matrixWorld))),i.ray}function A(e,n){var t=n.min,i=n.max,r=[new THREE.Vector3(t.x,t.y,t.z),new THREE.Vector3(t.x,t.y,i.z),new THREE.Vector3(t.x,i.y,i.z),new THREE.Vector3(i.x,i.y,i.z),new THREE.Vector3(i.x,i.y,t.z),new THREE.Vector3(i.x,t.y,t.z),new THREE.Vector3(t.x,i.y,t.z),new THREE.Vector3(i.x,t.y,i.z)],o=!0,c=!1,a=void 0;try{for(var l,s=r[Symbol.iterator]();!(o=(l=s.next()).done);o=!0){var d=l.value,u=!0,v=!1,E=void 0;try{for(var y,m=e[Symbol.iterator]();!(u=(y=m.next()).done);u=!0){if(y.value.distanceToPoint(d)<0)return!1}}catch(e){v=!0,E=e}finally{try{!u&&m.return&&m.return()}finally{if(v)throw E}}}}catch(e){c=!0,a=e}finally{try{!o&&s.return&&s.return()}finally{if(c)throw a}}return!0}function I(e,n){for(index in n){var t=n[index];if(collision.isIntersectionTriangleAABB(t.a,t.b,t.c,e))return!0}return!1}this.load=function(){return $(document).bind("keyup",i),l.impl.invalidate(!0),!0},this.unload=function(){return $(document).unbind("keyup",this.onKeyUp),!0},this.init=function(){var e=l.model;e.getData().instanceTree;O=e.getBoundingBox().getBoundingSphere();var n=e.getFragmentList(),t=n.fragments.boxes,i=n.fragments.fragId2dbId;_boundingBoxInfo=[];for(var r=0,o=0;o<i.length;o++){r=6*o;var c=new THREE.Box3(new THREE.Vector3(t[r],t[r+1],t[r+2]),new THREE.Vector3(t[r+3],t[r+4],t[r+5]));_boundingBoxInfo.push({bbox:c,dbId:i[o]})}v=new THREE.LineBasicMaterial({color:new THREE.Color(16711935),linewidth:1,opacity:.6,transparent:!0,depthTest:!1,depthWrite:!1})},this.handleSelect=function(e){if(c=null,Autodesk.Viewing.inFullscreen()&&(z=o.getBoundingClientRect().top,W=o.getBoundingClientRect().left),e){l.navigation.setIsLocked(!0),o.addEventListener("mousedown",g);var n=l.canvas,t=n.clientWidth,i=n.clientHeight,r=new THREE.OrthographicCamera(0,t,0,i,1,1e3);l.impl.createOverlayScene("selectionWindowOverlay",v,v,r)}else l.navigation.setIsLocked(!1),o.removeEventListener("mouseup",m),o.removeEventListener("mousemove",y),d=!1,l.impl.removeOverlayScene("selectionWindowOverlay")},document.addEventListener("keydown",function(e){var n=e.keyCode;c=n},!1)}MySelectionWindow.prototype=Object.create(Autodesk.Viewing.Extension.prototype),MySelectionWindow.prototype.varructor=MySelectionWindow,Autodesk.Viewing.theExtensionManager.registerExtension("MySelectionWindow",MySelectionWindow);